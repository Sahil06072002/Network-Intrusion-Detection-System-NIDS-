{% extends 'base.html' %}

{% block content %}

<div class="container-fluid px-4 py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">üõ°Ô∏è SECURITY COMMAND CENTER</h2>
            <p class="text-secondary mb-0">Real-Time Network Monitoring & Threat Detection</p>
        </div>
        {% if is_privileged %}
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center bg-dark rounded px-3 py-2 border border-secondary">
                <span class="live-indicator"></span>
                <span class="small fw-bold text-green">MONITORING</span>
            </div>
            <div class="text-end">
                <div class="small text-secondary">SYSTEM HEALTH</div>
                <div class="fw-bold {% if system_health.status == 'Healthy' %}text-green{% else %}text-red{% endif %}">
                    {{ system_health.status|upper }}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Live Network Status Panel -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card p-3 stat-card h-100 border-start border-4 border-primary">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-label">TOTAL DETECTED</div>
                        <div class="stat-value">{{ total_attacks }}</div>
                    </div>
                    <i class="bi bi-shield-exclamation fs-2 text-primary"></i>
                </div>
                <div class="mt-2 small text-secondary">Attacks Blocked</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 stat-card h-100 border-start border-4 border-success">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-label">NORMAL TRAFFIC</div>
                        <div class="stat-value">{{ normal_percent }}%</div>
                    </div>
                    <i class="bi bi-check-circle fs-2 text-success"></i>
                </div>
                <div class="progress mt-2" style="height: 4px; background: #334155;">
                    <div class="progress-bar bg-success" style="width: {{ normal_percent }}%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 stat-card h-100 border-start border-4 border-danger">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-label">MALICIOUS TRAFFIC</div>
                        <div class="stat-value">{{ malicious_percent }}%</div>
                    </div>
                    <i class="bi bi-bug fs-2 text-danger"></i>
                </div>
                <div class="progress mt-2" style="height: 4px; background: #334155;">
                    <div class="progress-bar bg-danger" style="width: {{ malicious_percent }}%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 stat-card h-100">
                <div class="stat-label mb-2">ACTIVE MODEL</div>
                {% if active_model %}
                <div class="fw-bold text-cyber">{{ active_model.model_name }}</div>
                <div class="small text-secondary mt-1">Accuracy: <span class="text-white">{{ active_model.accuracy
                        }}%</span></div>
                <div class="small text-secondary">Ver: {{ active_model.version }}</div>
                {% else %}
                <div class="text-warning">No Model Active</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="row g-3">
        <!-- Traffic Analysis -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-graph-up me-2"></i>Traffic Analysis</span>
                    <button class="btn btn-sm btn-outline-secondary">Download CSV</button>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Attack Distribution (with Percentages) -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <span><i class="bi bi-pie-chart me-2"></i>Attack Distribution (%)</span>
                </div>
                <div class="card-body d-flex flex-column justify-content-center">
                    <canvas id="distributionChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>

        <!-- NEW: Attack Comparison -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <span><i class="bi bi-bar-chart me-2"></i>Attack Comparison</span>
                </div>
                <div class="card-body">
                    <canvas id="comparisonChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- NEW: Daily Attack Mix -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <span><i class="bi bi-layers me-2"></i>Daily Attack Mix (Stacked)</span>
                </div>
                <div class="card-body">
                    <canvas id="mixChart" height="200"></canvas>
                </div>
            </div>
        </div>

        {% if is_privileged %}
        <!-- Expert Model Audit -->
        <div class="col-lg-12">
            <div class="card mt-3">
                <div class="card-header bg-dark border-bottom border-cyber">
                    <span class="text-cyber fw-bold"><i class="bi bi-cpu me-2"></i>EXPERT MODEL AUDIT: MULTI-MODEL
                        PERFORMANCE</span>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for item in model_performance %}
                        <div class="col-md-3">
                            <div class="p-3 bg-darker rounded border border-secondary text-center">
                                <div class="small text-secondary mb-1">DETECTION AGENT</div>
                                <div class="fw-bold text-cyber">{{ item.model_used }}</div>
                                <div class="mt-2 h2 mb-0">{{ item.count }}</div>
                                <div class="small text-success">Threats Neutralized</div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-4 text-secondary">
                            Waiting for multi-model telemetry data...
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if is_privileged %}
        <!-- Real-Time Alerts Feed -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-exclamation-triangle me-2"></i>Real-Time Alerts</span>
                    <span id="alert-count-badge" class="badge bg-danger">{{ total_alerts }} Total</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table mb-0 table-hover" id="live-alerts-table">
                            <thead>
                                <tr>
                                    <th>TIMESTAMP</th>
                                    <th>SEVERITY</th>
                                    <th>THREAT TYPE</th>
                                    <th>SOURCE IP</th>
                                    <th>STATUS</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in recent_alerts %}
                                <tr class="{% if alert.severity == 'critical' %}blink-red{% endif %}">
                                    <td class="font-monospace small">{{ alert.timestamp|date:"H:i:s" }}</td>
                                    <td>
                                        <span
                                            class="badge {% if alert.severity == 'critical' %}bg-danger{% elif alert.severity == 'high' %}bg-warning text-dark{% else %}bg-info{% endif %}">
                                            {{ alert.severity|upper }}
                                        </span>
                                    </td>
                                    <td>{{ alert.message }}</td>
                                    <td class="font-monospace">{{ alert.source_ip }}</td>
                                    <td>
                                        {% if alert.is_resolved %}
                                        <span class="text-success"><i class="bi bi-check2"></i> Resolved</span>
                                        {% else %}
                                        <span class="text-danger"><i class="bi bi-x-circle"></i> Active</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-secondary">No alerts received. System
                                        normal.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- For Standard Users: Show Recent File History -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-journal-text me-2"></i>My Recent File Analysis</span>
                    <a href="{% url 'file_list' %}" class="btn btn-sm btn-outline-primary">Browse All</a>
                </div>
                <div class="card-body">
                    <div class="text-center py-5">
                        <i class="bi bi-file-earmark-check fs-1 text-secondary mb-3"></i>
                        <h5>Your Security Data is Private</h5>
                        <p class="text-secondary">Standard users can only view their own file upload results. Use the
                            Traffic Monitor to view details.</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <span><i class="bi bi-lightning me-2"></i>Quick Actions</span>
                </div>
                <div class="card-body d-grid gap-3">
                    <a href="{% url 'file_list' %}"
                        class="btn btn-outline-success d-flex justify-content-between align-items-center p-3 text-start">
                        <div>
                            <div class="fw-bold">Traffic Monitor</div>
                            <div class="small">View Network Activity</div>
                        </div>
                        <i class="bi bi-play-circle fs-4"></i>
                    </a>
                    <a href="{% url 'upload_file' %}"
                        class="btn btn-outline-primary d-flex justify-content-between align-items-center p-3 text-start">
                        <div>
                            <div class="fw-bold">Upload Traffic</div>
                            <div class="small">Analyze Offline PCAP/CSV</div>
                        </div>
                        <i class="bi bi-cloud-upload fs-4"></i>
                    </a>
                    <a href="{% url 'file_list' %}"
                        class="btn btn-outline-info d-flex justify-content-between align-items-center p-3 text-start">
                        <div>
                            <div class="fw-bold">Reports Center</div>
                            <div class="small">Download PDF Summary</div>
                        </div>
                        <i class="bi bi-file-earmark-pdf fs-4"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // System Expert: Dashboard Logic (SRS 6.3)
    console.log("NIDS Dashboard Init...");

    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    const chartColors = ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#8b5cf6', '#6366f1'];

    // Data Parsing
    const trendLabels = {{ trend_labels_json| safe }};
    const trendData = {{ trend_data_json| safe }};
    const attackLabels = {{ attack_labels_json| safe }};
    const attackData = {{ attack_data_json| safe }};

    console.log("Trend Data:", trendData);
    console.log("Attack Data:", attackData);

    // 1. Line Chart: Traffic Analysis
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx && trendLabels.length > 0) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Traffic Volume',
                    data: trendData,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // 2. Pie Chart: Attack Distribution (%)
    const distCtx = document.getElementById('distributionChart');
    if (distCtx && attackData.length > 0) {
        const total = attackData.reduce((a, b) => a + b, 0);
        new Chart(distCtx, {
            type: 'pie',
            data: {
                labels: attackLabels,
                datasets: [{
                    data: attackData,
                    backgroundColor: chartColors,
                    borderWidth: 2,
                    borderColor: '#1e293b'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const val = ctx.raw;
                                const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                                return `${ctx.label}: ${val} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // 3. NEW: Attack Comparison (Bar Chart)
    const compCtx = document.getElementById('comparisonChart');
    if (compCtx && attackData.length > 0) {
        new Chart(compCtx, {
            type: 'bar',
            data: {
                labels: attackLabels,
                datasets: [{
                    label: 'Attack Count',
                    data: attackData,
                    backgroundColor: chartColors.map(c => c + '80'),
                    borderColor: chartColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' } }
                }
            }
        });
    }

    // 4. NEW: Daily Attack Mix (Stacked Bar)
    const mixCtx = document.getElementById('mixChart');
    if (mixCtx && trendLabels.length > 0) {
        const mixDatasets = [];
        let colorIdx = 0;
        {% for label, d in daily_mix_data.items %}
        mixDatasets.push({
            label: '{{ label }}',
            data: {{ d| safe }},
    backgroundColor: chartColors[colorIdx % chartColors.length]
        });
    colorIdx++;
    {% endfor %}

    new Chart(mixCtx, {
        type: 'bar',
        data: {
            labels: trendLabels,
            datasets: mixDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' } }
            }
        }
    });
    }

    {% if is_privileged %}
    function pollAlerts() {
        const tbody = document.querySelector('#live-alerts-table tbody');
        if (!tbody) return;
        fetch('{% url "recent_alerts_api" %}')
            .then(res => res.json())
            .then(data => {
                if (data.alerts && data.alerts.length > 0) {
                    let html = '';
                    data.alerts.forEach(a => {
                        html += `
                            <tr class="${a.severity === 'critical' ? 'blink-red' : ''}">
                                <td class="font-monospace small">${a.timestamp}</td>
                                <td><span class="badge ${a.severity === 'critical' ? 'bg-danger' : (a.severity === 'high' ? 'bg-warning text-dark' : 'bg-info')}">${a.severity.toUpperCase()}</span></td>
                                <td>${a.message}</td>
                                <td class="font-monospace">${a.source_ip}</td>
                                <td>${a.is_resolved ? '<span class="text-success">Resolved</span>' : '<span class="text-danger">Active</span>'}</td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                }
            });
    }
    setInterval(pollAlerts, 5000);
    pollAlerts();
    {% endif %}
</script>
{% endblock %}